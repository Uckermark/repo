<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css">
    <title>Uckermark's Repo</title>
</head>

<body>
    <div class="container">
        <h1>Uckermark's Repo</h1>

        <div class="button-container">
            <button id="add-to-cydia" onclick="addToCydia()">Add to Cydia</button>
            <button id="add-to-sileo" onclick="addToSileo()">Add to Sileo</button>
            <button id="add-to-zebra" onclick="addToZebra()">Add to Zebra</button>
            <button id="add-to-installer" onclick="addToInstaller()">Add to Installer</button>
        </div>

        <h2>Packages</h2>

        <div id="packages-container"></div>

        <script>
            const packageDataList = {};

            // Fetch Packages file from the repo
            fetch('https://repo.uckermark.dev/Packages')
                .then(response => response.text())
                .then(data => {
                    // Split the Packages file into individual package entries
                    const packages = data.split('\n\n');

                    // Store information about each package and its architectures
                    packages.forEach(packageData => {
                        const packageInfo = parsePackageInfo(packageData);
                        const packageName = packageInfo.Name;

                        if (!packageDataList[packageName]) {
                            packageDataList[packageName] = packageInfo;
                        } else {
                            packageDataList[packageName].Arch.push(...packageInfo.Arch);
                        }
                    });

                    // Display limited information for each unique package
                    const packagesContainer = document.getElementById('packages-container');
                    Object.values(packageDataList).forEach(packageInfo => {
                        const packageElement = createPackageElement(packageInfo);
                        packagesContainer.appendChild(packageElement);
                    });
                })
                .catch(error => console.error('Error fetching Packages file:', error));

            // Function to parse package information
            function parsePackageInfo(packageData) {
                const lines = packageData.split('\n');
                const packageInfo = {
                    Name: '',
                    Description: '',
                    Author: '',
                    Arch: [],
                    Download: '',
                    Icon: '',
                };

                lines.forEach(line => {
                    const [key, value] = line.split(': ');
                    if (key && value) {
                        if (key === 'Name') packageInfo.Name = value;
                        else if (key === 'Description') packageInfo.Description = value;
                        else if (key === 'Author') packageInfo.Author = value;
                        else if (key === 'Architecture') packageInfo.Arch.push(value);
                        else if (key === 'Filename') packageInfo.Download = `https://repo.uckermark.dev/${value}`;
                        else if (key === 'Icon') packageInfo.Icon = value;
                    }
                });

                return packageInfo;
            }

            // Function to create HTML element for a package
            function createPackageElement(packageInfo) {
                // Skip packages without a name (empty Name field)
                if (!packageInfo.Name) {
                    return document.createElement('div');
                }

                const packageElement = document.createElement('div');
                packageElement.classList.add('package-box');

                // Display package icon
                if (packageInfo.Icon) {
                    const iconElement = document.createElement('img');
                    iconElement.src = packageInfo.Icon;
                    iconElement.alt = 'Package Icon';
                    packageElement.appendChild(iconElement);
                }

                // Display package information
                const infoElement = document.createElement('div');
                infoElement.classList.add('package-info');

                // Display package name, description, and author
                ['Name', 'Description', 'Author'].forEach(key => {
                    const detailElement = document.createElement('p');
                    detailElement.innerHTML = `<strong>${key}:</strong> ${packageInfo[key]}`;
                    infoElement.appendChild(detailElement);
                });

                // Display download button for each architecture
                packageInfo.Arch.forEach(arch => {
                    const downloadButton = document.createElement('a');
                    downloadButton.classList.add('download-button');
                    downloadButton.href = packageInfo.Download.replace(/_[^.]+\.deb$/, `_${arch}.deb`);
                    downloadButton.setAttribute('target', '_blank'); // Open link in a new tab
                    downloadButton.textContent = `Download for ${arch}`;
                    infoElement.appendChild(downloadButton);
                });

                packageElement.appendChild(infoElement);

                return packageElement;
            }

            // Functions to add repo to package managers
            function addToCydia() {
                window.location.href = 'cydia://url/https://cydia.saurik.com/api/share#?source=https://repo.uckermark.dev';
            }

            function addToSileo() {
                window.location.href = 'sileo://source/https://repo.uckermark.dev';
            }

            function addToZebra() {
                window.location.href = 'zbra://sources/add/https://repo.uckermark.dev';
            }

            function addToInstaller() {
                window.location.href = 'installer://add/repo=https://repo.uckermark.dev';
            }
        </script>
    </div>
</body>

</html>

